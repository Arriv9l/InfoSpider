name: test

on:
  push:
    branches: [ test ]
  workflow_dispatch:

jobs:
  Prerequisites:
    runs-on: ubuntu-latest
    # steps ä¹‹é—´ä¼ é€’æ•°æ®å¯ä»¥é€šè¿‡ ${{ steps.step1.outputs.test }}
    # è€Œ jobs ä¹‹é—´ä¼ é€’åˆ™éœ€è¦é  ${{needs.job1.outputs.output1}}
    # å…·ä½“è§ https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions#jobsjob_idoutputs
    outputs:
      flag: ${{ steps.get-paths.outputs.flag }}
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2

      # æœ¬æ¥æ ¹æ® https://docs.github.com/en/developers/webhooks-and-events/webhook-events-and-payloads#push
      # å’Œ https://docs.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#object-filters
      # åœ¨ PUSH ä¸­å¯ä»¥é€šè¿‡ ${{ github.event.commits.*.added }} æ¥è·å– added,modified,removed æ–‡ä»¶
      # ä½†æ˜¯æ ¹æ® https://github.blog/changelog/2019-10-16-changes-in-github-actions-push-event-payload/
      # è¿™ä¸‰ä¸ªå±æ€§å·²ç»è¢«åˆ é™¤äº†ï¼Œæ‰€ä»¥åªèƒ½ç”¨ https://docs.github.com/en/rest/reference/repos#compare-two-commits
      - name: Get Paths
        id: get-paths
        uses: actions/github-script@v3
        env:
          repository: ${{ github.repository }} # The owner and repository name. For example, Codertocat/Hello-World.
          before: ${{ github.event.before }}
          after: ${{ github.event.after }}
        # æ ¹æ® https://github.com/actions/github-script#download-data-from-a-url
        # ç”¨ github.request() æ¥ä¸‹è½½ï¼Œresult.data å·²è§£æä¸º JSON
        # æ³¨æ„ match çš„ç”¨æ³•ï¼š(.match() || [])[0]
        # ç”¨ indexOf() å®ç°æ•°ç»„å»é‡
        # ç”¨ fs.existsSync() åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        # å®æµ‹å‘ç°ï¼Œå¯ä»¥ç›´æ¥ç”¨ require('fs')ï¼Œä½†ä¸èƒ½ç”¨ import
        with:
          script: |
            const fs = require('fs')
            const result = await github.request("https://api.github.com/repos/Arriv9l/InfoSpider/compare/81a324dd6eb7071a17c2baa82b62d409058c1e9d...cbde965224c81ff88663fcddd292ce5deb944d2a")
            const paths = result.data.files
              .map(x => (x['filename'].match(/part\d\/.+?(?=\/)/) || [])[0])
              .filter(Boolean)
              .filter((item, index, array) => array.indexOf(item) === index)
              .filter(x => fs.existsSync(x))
            core.setOutput('paths', paths)
            core.setOutput('flag', paths.length ? 'true' : 'false')

      - name: Set Matrix
        id: set-matrix
        uses: actions/github-script@v3
        # å®æµ‹å‘ç°ï¼Œå½“ flag çš„å€¼ä¸ºå¸ƒå°”å€¼ true æ—¶ï¼Œä¸èƒ½æ­£å¸¸åˆ¤æ–­
        # æ‰€ä»¥éœ€è¦å°† flag æ”¹ä¸ºå­—ç¬¦ä¸² 'true'ï¼Œå†å»åˆ¤æ–­ flag == 'true'
        if: ${{ steps.get-paths.outputs.flag == 'true' }}
        with:
          script: |
            const matrix = {}
            matrix.path = ${{ steps.get-paths.outputs.paths }}
            core.setOutput('matrix', JSON.stringify(matrix))


  README:
    runs-on: ubuntu-latest
    needs: Prerequisites
    if: ${{ needs.Prerequisites.outputs.flag == 'true' }}
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2

      - name: test
        uses: actions/github-script@v3
        with:
          script: |
            const paths = core.getInput('paths')
            console.log(paths)

      # å¦‚æœ README ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨åˆ›å»ºï¼›å¦åˆ™ï¼Œè·³è¿‡è¯¥ step
      - name: Add README ğŸ“
        id: add-readme
        uses: actions/github-script@v3
        with:
          script: |
            const fs = require('fs')
            const paths = core.getInput('paths').filter(path => !fs.existsSync(`${path}/README.md`))
            const readmes = paths.map(path => {
              const readme = `${path}/README.md`
              const text = `# Preview\nhttps://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${path}`
              fs.writeFileSync(readme, text)
              return readme
            })
            core.setOutput('readmes', readmes)

      - name: test2
        run: |
          echo ${{ steps.add-readme.outputs.readmes }}
          echo ${{ join(steps.add-readme.outputs.readmes) }}
          echo ${{ join(steps.add-readme.outputs.readmes) == '' }}
          echo ${{ join(steps.add-readme.outputs.readmes) == '[]' }}

      # æ ¹æ® https://github.community/t/parameter-on-step-if-previous-skipped/18320/4
      # æ¥åˆ¤æ–­æ¡ä»¶ï¼šå¦‚æœä¸Šä¸€ä¸ª step è¢«è·³è¿‡ï¼Œåˆ™æ­¤ step ä¹Ÿè·³è¿‡
      # å¦åˆ™çš„è¯è‡ªåŠ¨å‘ commit https://github.com/marketplace/actions/add-commit
      # å®æµ‹å‘ç°è‡ªåŠ¨å‘ commit å¹¶ä¸ä¼šå†æ¬¡è§¦å‘ Actionsï¼Œå¯¼è‡´æ­»å¾ªç¯
      - name: Auto Commit ğŸ“
        uses: EndBug/add-and-commit@v7
        if: ${{ steps.add-readme.outputs.readmes != '[]' }}
        with:
          message: 'ğŸ“ Auto Add README'
          add: ${{ steps.add-readme.outputs.readmes }}


  Deploy:
    runs-on: ubuntu-latest
    needs: Prerequisites
    if: ${{ needs.Prerequisites.outputs.flag == 'true' }}
    # æ¥è‡ª https://github.community/t/check-pushed-file-changes-with-git-diff-tree-in-github-actions/17220/10
    strategy:
      matrix: ${{ fromJson(needs.Prerequisites.outputs.matrix) }}

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2

      # å®æµ‹å‘ç°
      # ä¸åº”è¯¥å¾€ package.json ä¸­æ·»åŠ  "homepage" : "part1/1.1"ï¼Œè¿™æ ·ä¼šå¯¼è‡´é“¾æ¥å˜ä¸º https://arriv9l.github.io/part1/1.1/xxxï¼Œç¼ºå°‘äº†ä»“åº“å
      # ä¹Ÿä¸åº”è¯¥è®¾ç½® PUBLIC_URL=REPO_NAME/part1/1.1ï¼Œè¿™æ ·ä¼šå¯¼è‡´é“¾æ¥å˜ä¸º https://arriv9l.github.io/REPO_NAME/part1/1.1/REPO_NAME/part1/1.1/xxxï¼Œé‡å¤äº† REPO_NAME/part1/1.1
      # è€Œåº”è¯¥è®¾ç½® PUBLIC_URL=./ï¼Œè¿™æ ·é“¾æ¥æ‰èƒ½ä¸ºæ­£å¸¸æ ¼å¼çš„ https://arriv9l.github.io/REPO_NAME/part1/1.1/xxx
      # è®¾ç½®ç¯å¢ƒå˜é‡çš„æ•™ç¨‹è§ https://create-react-app.dev/docs/adding-custom-environment-variables/#adding-temporary-environment-variables-in-your-shell
      - name: Install and Build ğŸ”§
        run: |
          cd ${{ matrix.path }}
          yarn
          PUBLIC_URL=./ yarn build

      - name: Deploy ğŸš€
        uses: JamesIves/github-pages-deploy-action@4.0.0
        with:
          branch: gh-pages
          folder: ${{ matrix.path }}/build
          target-folder: ${{ matrix.path }}
          clean: false