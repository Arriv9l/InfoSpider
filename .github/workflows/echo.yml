name: test

on:
  push:
    branches: [ test ]
  workflow_dispatch:
    inputs:
      url:
        description: 'URL to debug'
        required: true

jobs:
  Prerequisites:
    runs-on: ubuntu-latest
    # steps ä¹‹é—´ä¼ é€’æ•°æ®å¯ä»¥é€šè¿‡ ${{ steps.step1.outputs.test }}
    # è€Œ jobs ä¹‹é—´ä¼ é€’åˆ™éœ€è¦é  ${{needs.job1.outputs.output1}}
    # å…·ä½“è§ https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions#jobsjob_idoutputs
    outputs:
      heroku-paths: ${{ steps.get-paths.outputs.heroku-paths }}
      pages-paths: ${{ steps.get-paths.outputs.pages-paths }}
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2

      # æœ¬æ¥æ ¹æ® https://docs.github.com/en/developers/webhooks-and-events/webhook-events-and-payloads#push
      # å’Œ https://docs.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#object-filters
      # åœ¨ PUSH ä¸­å¯ä»¥é€šè¿‡ ${{ github.event.commits.*.added }} æ¥è·å– added,modified,removed æ–‡ä»¶
      # ä½†æ˜¯æ ¹æ® https://github.blog/changelog/2019-10-16-changes-in-github-actions-push-event-payload/
      # è¿™ä¸‰ä¸ªå±æ€§å·²ç»è¢«åˆ é™¤äº†ï¼Œæ‰€ä»¥åªèƒ½ç”¨ https://docs.github.com/en/rest/reference/repos#compare-two-commits
      - name: Get Paths
        id: get-paths
        uses: actions/github-script@v3
        # https://github.com/actions/github-script#download-data-from-a-url
        # ç”¨ github.request() æ¥ä¸‹è½½ï¼Œresult.data å·²è§£æä¸º JSON
        # æ³¨æ„ match çš„ç”¨æ³•ï¼š(.match() || [])[0]
        # ç”¨ indexOf() å®ç°æ•°ç»„å»é‡
        # ç”¨ fs.existsSync() åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        # å®æµ‹å‘ç°ï¼Œå¯ä»¥ç›´æ¥ç”¨ require('fs')ï¼Œä½†ä¸èƒ½ç”¨ importï¼Œé‚£æ˜¯ TypeScript çš„è¯­æ³•
        with:
          script: |
            const fs = require('fs')
            const url = '${{ github.event.inputs.url }}' || 'https://api.github.com/repos/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.event.after }}'
            const result = await github.request(url)
            const paths = result.data.files
                          .map(x => (x['filename'].match(/part\d\/.+?(?=\/)/) || [])[0])
                          .filter(Boolean)
                          .filter((item, index, array) => array.indexOf(item) === index)
                          .filter(x => fs.existsSync(x))
            const pagesPaths = paths.filter(path => !fs.existsSync(`${path}/Procfile`))
            const herokuPaths = paths.filter(path => !pagesPaths.includes(path))
                                     .filter(path => !fs.existsSync(`${path}/README.md`))
            core.setOutput('pages-paths', pagesPaths)
            core.setOutput('heroku-paths', herokuPaths)

      - name: Set Matrix
        id: set-matrix
        uses: actions/github-script@v3
        # åˆ¤æ–­æ•°ç»„æ˜¯å¦ä¸ºç©ºï¼Œç”¨ '[]'ï¼ŒåŠ ä¸åŠ  join() éƒ½å¯ä»¥
        if: ${{ steps.get-paths.outputs.pages-paths != '[]' }}
        with:
          script: |
            const matrix = {}
            matrix.path = ${{ steps.get-paths.outputs.pages-paths }}
            core.setOutput('matrix', JSON.stringify(matrix))


  Build:
    runs-on: ubuntu-latest
    needs: Prerequisites
    if: ${{ needs.Prerequisites.outputs.pages-paths != '[]' }}
    # æ¥è‡ª https://github.community/t/check-pushed-file-changes-with-git-diff-tree-in-github-actions/17220/10
    strategy:
      matrix: ${{ fromJson(needs.Prerequisites.outputs.matrix) }}

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2

      # https://github.com/actions/cache/blob/main/examples.md#node---yarn
      # å®æµ‹å‘ç°ï¼ŒåŠ ä¸Šç¼“å­˜åï¼Œæ—¶é—´ç”± 60s ç¼©çŸ­åˆ°äº† 30s
      # ä½†ä»¥åçš„è¯ï¼Œæœ€å¥½åœ¨ PUSH æ—¶åŠ ä¸Š yarn.lock æ–‡ä»¶
      # ä¸è¿‡ä¸åŠ çš„è¯åº”è¯¥ä¹Ÿæ— æ‰€è°“å§ï¼Œæœ‰å¾…æµ‹è¯•
      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "::set-output name=dir::$(yarn cache dir)"

      - uses: actions/cache@v2
        id: yarn-cache # use this to check for `cache-hit` (`steps.yarn-cache.outputs.cache-hit != 'true'`)
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      # å®æµ‹å‘ç°
      # ä¸åº”è¯¥å¾€ package.json ä¸­æ·»åŠ  "homepage" : "part1/1.1"ï¼Œè¿™æ ·ä¼šå¯¼è‡´é“¾æ¥å˜ä¸º https://arriv9l.github.io/part1/1.1/xxxï¼Œç¼ºå°‘äº†ä»“åº“å
      # ä¹Ÿä¸åº”è¯¥è®¾ç½® PUBLIC_URL=REPO_NAME/part1/1.1ï¼Œè¿™æ ·ä¼šå¯¼è‡´é“¾æ¥å˜ä¸º https://arriv9l.github.io/REPO_NAME/part1/1.1/REPO_NAME/part1/1.1/xxxï¼Œé‡å¤äº† REPO_NAME/part1/1.1
      # è€Œåº”è¯¥è®¾ç½® PUBLIC_URL=./ï¼Œè¿™æ ·é“¾æ¥æ‰èƒ½ä¸ºæ­£å¸¸æ ¼å¼çš„ https://arriv9l.github.io/REPO_NAME/part1/1.1/xxx
      # è®¾ç½®ç¯å¢ƒå˜é‡çš„æ•™ç¨‹è§ https://create-react-app.dev/docs/adding-custom-environment-variables/#adding-temporary-environment-variables-in-your-shell
      - name: Install and Build ğŸ”§
        run: |
          cd ${{ matrix.path }}
          yarn
          PUBLIC_URL=./ yarn build

      - name: Set Artifact Name
        id: set-name
        uses: actions/github-script@v3
        with:
          script: |
            core.setOutput('name', '${{ matrix.path }}/build'.replace(/\//g, '-'))

      # https://github.com/actions/upload-artifact#too-many-uploads-resulting-in-429-responses
      # As an example, imagine an artifact with 1000 files (each 10 Kb in size).
      # Without any modification, there would be around 1000 HTTP calls made to upload the artifact.
      # If you zip or archive the artifact beforehand, the number of HTTP calls can be dropped to single digit territory.
      # ç”±äº build æ–‡ä»¶å¤¹ä¸‹å†…å®¹ä¸å¤šï¼Œæ‰€ä»¥æ­¤å¤„ä¸å‹ç¼©
      - name: Upload Artifact ğŸ“¦
        uses: actions/upload-artifact@v2
        with:
          name: ${{ steps.set-name.outputs.name }}
          path: ${{ matrix.path }}/build
          retention-days: 1


  Deploy-Pages:
    runs-on: ubuntu-latest
    needs: [ Prerequisites, Build ]
    if: ${{ needs.Prerequisites.outputs.pages-paths != '[]' }}
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2

      - name: Download all workflow run artifacts ğŸ“¦
        uses: actions/download-artifact@v2

      # æ­¤å¤„è¦æ³¨æ„åœ¨ç®­å¤´å‡½æ•°çš„ {} å¤–é¢åŠ ä¸Š ()
      - name: setFolderMap
        id: set-folderMap
        uses: actions/github-script@v3
        with:
          script: |
            const paths = ${{ needs.Prerequisites.outputs.pages-paths }}
            const folderMap = paths.map(path => ({
              folder: `${path}/build`.replace(/\//g, '-'),
              targetFolder: path,
            }))
            core.setOutput('folderMap', JSON.stringify(folderMap)) // ä¹Ÿå¯ä»¥ä¸ç”¨ JSON.stringify()
            core.setOutput('folder', `${paths[0]}/build`.replace(/\//g, '-'))

      # å®æµ‹å‘ç°ï¼Œfolder ä¸èƒ½ç”¨ ${{ needs.Prerequisites.outputs.paths[0] }}/build
      # ä¼°è®¡æ˜¯å› ä¸º paths æ˜¯å­—ç¬¦ä¸²è€Œéæ•°ç»„å§
      - name: Deploy ğŸš€
        uses: Arriv9l/github-pages-deploy-action@v1.0
        with:
          branch: gh-pages
          folder: ${{ steps.set-folderMap.outputs.folder }}
          folder-map: ${{ steps.set-folderMap.outputs.folderMap }}


  Deploy-Heroku:
    runs-on: ubuntu-latest
    needs: Prerequisites
    if: ${{ needs.Prerequisites.outputs.heroku-paths != '[]' }}
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2

      # https://github.com/Atrox/haikunatorjs
      # æ²¡æœ‰å½“å‰è·¯å¾„ä¸‹æ²¡æœ‰ package.jsonï¼Œæ‰€ä»¥å¿…é¡»ä»¥ require('./node_modules/xxx') çš„æ–¹å¼å¯¼å…¥æ¨¡å—
      # å“ªæ€•ç”¨ npm install -g çš„æ–¹å¼å…¨å±€å®‰è£…ï¼Œä¹Ÿä¸èƒ½ç”¨ require('xxx')
      # BTWï¼Œå¦‚æœè¦æƒ³ç”¨ -g å…¨å±€å®‰è£…ï¼Œå¿…é¡»åŠ ä¸Š actions/setup-node@v2
      # Alsoï¼Œæœ¬æ¥ä»¥ä¸ºå¤šè¡Œä»£ç è¦åœ¨æœ«å°¾ç”¨ \ åæ–œæ çš„ï¼Œå®æµ‹å‘ç°å¯ç”¨å¯ä¸ç”¨
      # Lastlyï¼Œæ ¹æ® https://nodejs.org/api/cli.html#cli_e_eval_scriptï¼Œ
      # åœ¨ Windows node -e '' å•å¼•å·å¹¶ä¸èµ·ä½œç”¨ï¼Œæ‰€ä»¥æœ€å¥½ç»Ÿä¸€ç”¨ "" åŒå¼•å·
      - name: Get Heroku-like Random Name
        id: get-name
        run: |
          npm install haikunator
          name=$(node -e "const Haikunator = require('./node_modules/haikunator')
                          const haikunator = new Haikunator()
                          const name = haikunator.haikunate()
                          console.log(name)")
          echo "::set-output name=name::$name"

      # ç”±äºå¿…é¡»è¦å…ˆç”¨ heroku create æ¥â€æ³¨å†Œâ€œä¸€ä¸ª HEROKU_APP_NAMEï¼Œ
      # ç›´æ¥ç”Ÿæˆå git push çš„è¯æ˜¯ä¸å…è®¸çš„ï¼Œä¼šæŠ¥é”™ 'No such app as HEROKU_APP_NAME'
      # éš¾æ€ªç½‘ä¸Šå…³äºå–ä¸€ä¸ª unique çš„ HEROKU_APP_NAME çš„èµ„æ–™é‚£ä¹ˆå°‘
      - name: Deploy to Heroku
        if: false
        env:
          HEROKU_API_TOKEN: ${{ secrets.HEROKU_API_TOKEN }}
          HEROKU_APP_NAME: ${{ steps.get-name.outputs.name }}
        run: |
          git remote add heroku https://heroku:$HEROKU_API_TOKEN@git.heroku.com/damp-plateau-93441.git
          git subtree push --prefix part3/3.1 heroku test


  README:
    runs-on: ubuntu-latest
    needs: [ Prerequisites, Deploy-Pages, Deploy-Heroku ]
    if: ${{ needs.Prerequisites.outputs.heroku-paths != '[]' || needs.Prerequisites.outputs.pages-paths != '[]' }}
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2

      # è‡ªåŠ¨åˆ›å»ºæ‰€æœ‰ç¼ºå¤±çš„ README
      - name: Add README ğŸ“
        id: add-readme
        uses: actions/github-script@v3
        with:
          script: |
            const fs = require('fs')
            const paths = [
              ...${{ needs.Prerequisites.outputs.heroku-paths }},
              ...${{ needs.Prerequisites.outputs.pages-paths }}.filter(path => !fs.existsSync(`${path}/README.md`))
            ]
            const readmes = paths.map(path => {
              const readme = `${path}/README.md`
              let text
              if (!fs.existsSync(`${path}/Procfile`)) {
                text = `# Preview\nhttps://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${path}`
              } else {
                text = `https://$HEROKU_APP_NAME.herokuapp.com/`
              }
              fs.writeFileSync(readme, text)
              return readme
            })
            core.setOutput('readmes', readmes)

      # https://github.com/marketplace/actions/add-commit
      # å¦‚æœ readmes æ•°ç»„ä¸ä¸ºç©ºï¼Œåˆ™è‡ªåŠ¨å‘ commit
      # commit ä¸­æ·»åŠ çš„æ–‡ä»¶ä¸ºæ•°ç»„ï¼Œå°±é¿å…äº†ä¸€ä¸ªæ–‡ä»¶ä¸€ä¸ª commitï¼Œæœ‰ç‚¹åˆ·ç»¿å¢™çš„å«Œç–‘
      # å®æµ‹å‘ç°è‡ªåŠ¨å‘ commit å¹¶ä¸ä¼šå†æ¬¡è§¦å‘ Actionsï¼Œå¯¼è‡´æ­»å¾ªç¯
      - name: Auto Commit ğŸ“
        uses: EndBug/add-and-commit@v7
        if: ${{ steps.add-readme.outputs.readmes != '[]' }}
        with:
          message: 'ğŸ“ Auto Add README'
          add: ${{ steps.add-readme.outputs.readmes }}