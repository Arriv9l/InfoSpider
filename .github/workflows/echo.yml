name: test

on:
  push:
    branches: [ test ]
  workflow_dispatch:
    inputs:
      url:
        description: 'URL to debug'
        required: true

jobs:
  Prerequisites:
    runs-on: ubuntu-latest
    # steps ä¹‹é—´ä¼ é€’æ•°æ®å¯ä»¥é€šè¿‡ ${{ steps.step1.outputs.test }}
    # è€Œ jobs ä¹‹é—´ä¼ é€’åˆ™éœ€è¦é  ${{needs.job1.outputs.output1}}
    # å…·ä½“è§ https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions#jobsjob_idoutputs
    outputs:
      paths: ${{ steps.get-paths.outputs.paths }}
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2

      - name: setObj
        id: set-obj
        uses: actions/github-script@v3
        with:
          script: |
            const obj = [
              {folder: 'part1/1.1', targetFolder: 'part1/1.1/build'},
              {folder: 'part2/2.2', targetFolder: 'part2/2.2/build'},
              {folder: 'part3/3.3', targetFolder: 'part3/3.3/build'},
            ]
            // core.setOutput('obj', JSON.stringify(obj))
            core.setOutput('obj', obj)

      - name: getObj
        uses: actions/github-script@v3
        with:
          script: |
            const branch = core.getInput('previews')
            console.log(`branch: ${branch}`)

            let test = core.getInput('user-agent')
            console.log(`test-1: ${test}`)
            test = JSON.parse(test)
            console.log(`test-2: ${test}`)
            test.map(each => console.log(`${each.folder} ${each.targetFolder}`))
            
            let obj = core.getInput('obj')
            console.log(`obj-1: ${obj}`)
            obj = JSON.parse(obj)
            console.log(`obj-2: ${obj}`)
            obj.map(each => console.log(`${each.folder} ${each.targetFolder}`))
          previews: gh-pages
          user-agent: ${{ steps.set-obj.outputs.obj }}

      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJSON(github) }}
        run: echo "$GITHUB_CONTEXT"

      # æœ¬æ¥æ ¹æ® https://docs.github.com/en/developers/webhooks-and-events/webhook-events-and-payloads#push
      # å’Œ https://docs.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#object-filters
      # åœ¨ PUSH ä¸­å¯ä»¥é€šè¿‡ ${{ github.event.commits.*.added }} æ¥è·å– added,modified,removed æ–‡ä»¶
      # ä½†æ˜¯æ ¹æ® https://github.blog/changelog/2019-10-16-changes-in-github-actions-push-event-payload/
      # è¿™ä¸‰ä¸ªå±æ€§å·²ç»è¢«åˆ é™¤äº†ï¼Œæ‰€ä»¥åªèƒ½ç”¨ https://docs.github.com/en/rest/reference/repos#compare-two-commits
      - name: Get Paths
        id: get-paths
        uses: actions/github-script@v3
        # https://github.com/actions/github-script#download-data-from-a-url
        # ç”¨ github.request() æ¥ä¸‹è½½ï¼Œresult.data å·²è§£æä¸º JSON
        # æ³¨æ„ match çš„ç”¨æ³•ï¼š(.match() || [])[0]
        # ç”¨ indexOf() å®ç°æ•°ç»„å»é‡
        # ç”¨ fs.existsSync() åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        # å®æµ‹å‘ç°ï¼Œå¯ä»¥ç›´æ¥ç”¨ require('fs')ï¼Œä½†ä¸èƒ½ç”¨ importï¼Œé‚£æ˜¯ TypeScript çš„è¯­æ³•
        with:
          script: |
            const fs = require('fs')
            const url = '${{ github.event.inputs.url }}' || 'https://api.github.com/repos/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.event.after }}'
            const result = await github.request(url)
            const paths = result.data.files
              .map(x => (x['filename'].match(/part\d\/.+?(?=\/)/) || [])[0])
              .filter(Boolean)
              .filter((item, index, array) => array.indexOf(item) === index)
              .filter(x => fs.existsSync(x))
            core.setOutput('paths', paths)

      - name: Set Matrix
        id: set-matrix
        uses: actions/github-script@v3
        # åˆ¤æ–­æ•°ç»„æ˜¯å¦ä¸ºç©ºï¼Œç”¨ '[]'ï¼ŒåŠ ä¸åŠ  join() éƒ½å¯ä»¥
        if: ${{ steps.get-paths.outputs.paths != '[]' }}
        with:
          script: |
            const matrix = {}
            matrix.path = ${{ steps.get-paths.outputs.paths }}
            core.setOutput('matrix', JSON.stringify(matrix))


  README:
    runs-on: ubuntu-latest
    needs: Prerequisites
    if: ${{ needs.Prerequisites.outputs.paths != '[]' }}
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2

      # è‡ªåŠ¨åˆ›å»ºæ‰€æœ‰ç¼ºå¤±çš„ README
      - name: Add README ğŸ“
        id: add-readme
        uses: actions/github-script@v3
        with:
          script: |
            const fs = require('fs')
            const paths = ${{ needs.Prerequisites.outputs.paths }}.filter(path => !fs.existsSync(`${path}/README.md`))
            const readmes = paths.map(path => {
              const readme = `${path}/README.md`
              const text = `# Preview\nhttps://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${path}`
              fs.writeFileSync(readme, text)
              return readme
            })
            core.setOutput('readmes', readmes)

      # https://github.com/marketplace/actions/add-commit
      # å¦‚æœ readmes æ•°ç»„ä¸ä¸ºç©ºï¼Œåˆ™è‡ªåŠ¨å‘ commit
      # commit ä¸­æ·»åŠ çš„æ–‡ä»¶ä¸ºæ•°ç»„ï¼Œå°±é¿å…äº†ä¸€ä¸ªæ–‡ä»¶ä¸€ä¸ª commitï¼Œæœ‰ç‚¹åˆ·ç»¿å¢™çš„å«Œç–‘
      # å®æµ‹å‘ç°è‡ªåŠ¨å‘ commit å¹¶ä¸ä¼šå†æ¬¡è§¦å‘ Actionsï¼Œå¯¼è‡´æ­»å¾ªç¯
      - name: Auto Commit ğŸ“
        uses: EndBug/add-and-commit@v7
        if: ${{ steps.add-readme.outputs.readmes != '[]' }}
        with:
          message: 'ğŸ“ Auto Add README'
          add: ${{ steps.add-readme.outputs.readmes }}


  Deploy:
    runs-on: ubuntu-latest
    needs: Prerequisites
    if: ${{ needs.Prerequisites.outputs.paths != '[]' }}
    # æ¥è‡ª https://github.community/t/check-pushed-file-changes-with-git-diff-tree-in-github-actions/17220/10
    strategy:
      matrix: ${{ fromJson(needs.Prerequisites.outputs.matrix) }}

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2

      # https://github.com/actions/cache/blob/main/examples.md#node---yarn
      # å®æµ‹å‘ç°ï¼ŒåŠ ä¸Šç¼“å­˜åï¼Œæ—¶é—´ç”± 60s ç¼©çŸ­åˆ°äº† 30s
      # ä½†ä»¥åçš„è¯ï¼Œæœ€å¥½åœ¨ PUSH æ—¶åŠ ä¸Š yarn.lock æ–‡ä»¶
      # ä¸è¿‡ä¸åŠ çš„è¯åº”è¯¥ä¹Ÿæ— æ‰€è°“å§ï¼Œæœ‰å¾…æµ‹è¯•
      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "::set-output name=dir::$(yarn cache dir)"

      - uses: actions/cache@v2
        id: yarn-cache # use this to check for `cache-hit` (`steps.yarn-cache.outputs.cache-hit != 'true'`)
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      # å®æµ‹å‘ç°
      # ä¸åº”è¯¥å¾€ package.json ä¸­æ·»åŠ  "homepage" : "part1/1.1"ï¼Œè¿™æ ·ä¼šå¯¼è‡´é“¾æ¥å˜ä¸º https://arriv9l.github.io/part1/1.1/xxxï¼Œç¼ºå°‘äº†ä»“åº“å
      # ä¹Ÿä¸åº”è¯¥è®¾ç½® PUBLIC_URL=REPO_NAME/part1/1.1ï¼Œè¿™æ ·ä¼šå¯¼è‡´é“¾æ¥å˜ä¸º https://arriv9l.github.io/REPO_NAME/part1/1.1/REPO_NAME/part1/1.1/xxxï¼Œé‡å¤äº† REPO_NAME/part1/1.1
      # è€Œåº”è¯¥è®¾ç½® PUBLIC_URL=./ï¼Œè¿™æ ·é“¾æ¥æ‰èƒ½ä¸ºæ­£å¸¸æ ¼å¼çš„ https://arriv9l.github.io/REPO_NAME/part1/1.1/xxx
      # è®¾ç½®ç¯å¢ƒå˜é‡çš„æ•™ç¨‹è§ https://create-react-app.dev/docs/adding-custom-environment-variables/#adding-temporary-environment-variables-in-your-shell
      - name: Install and Build ğŸ”§
        run: |
          cd ${{ matrix.path }}
          yarn
          PUBLIC_URL=./ yarn build

      - name: Deploy ğŸš€
        uses: JamesIves/github-pages-deploy-action@4.0.0
        with:
          branch: gh-pages
          folder: ${{ matrix.path }}/build
          target-folder: ${{ matrix.path }}
          clean: false